{% extends "base.html" %}

{% block title %}Tag Analysis - {{ tag }}{% endblock %}

{% block content %}
    <div class="container">

        <!-- Breadcrumb Navigation -->
        <nav class="breadcrumb" style="margin-bottom: 20px; padding: 10px 0; color: #6b7280;">
            <a href="/" style="color: #3b82f6; text-decoration: none;">📊 Dashboard</a>
            <span style="margin: 0 10px;">/</span>
            <a href="/#tagsChart" style="color: #3b82f6; text-decoration: none;">Tags</a>
            <span style="margin: 0 10px;">/</span>
            <span style="font-weight: 600;">{{ tag }}</span>
        </nav>

        <!-- Header -->
        <div class="dashboard-header">
            <h2>🏷️ Tag Analysis: <span class="tag" style="font-size: 1.2em; padding: 8px 16px;">{{ tag }}</span></h2>
            <div class="header-actions">
                <button onclick="window.location.href='/'" class="btn btn-secondary">← Back to Dashboard</button>
                <button onclick="exportTagData()" class="btn btn-primary">📥 Export CSV</button>
                <button onclick="window.print()" class="btn btn-secondary">🖨️ Print Report</button>
            </div>
        </div>

        <!-- Overview Stats -->
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div class="stat-card">
                <div class="stat-icon">🧪</div>
                <div class="stat-content">
                    <h3 id="total-tests">{{ data.total_test_count }}</h3>
                    <p>Unique Tests</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔄</div>
                <div class="stat-content">
                    <h3 id="total-executions">{{ data.total_executions }}</h3>
                    <p>Total Executions</p>
                </div>
            </div>
            <div class="stat-card {% if data.overall_pass_rate >= 80 %}success{% elif data.overall_pass_rate >= 50 %}warning{% else %}danger{% endif %}">
                <div class="stat-icon">📈</div>
                <div class="stat-content">
                    <h3 id="pass-rate">{{ data.overall_pass_rate }}%</h3>
                    <p>Overall Pass Rate</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                    <h3 id="total-runs">{{ data.total_runs }}</h3>
                    <p>Runs with Tag</p>
                </div>
            </div>
            {% if data.flaky_count > 0 %}
                <div class="stat-card warning">
                    <div class="stat-icon">⚠️</div>
                    <div class="stat-content">
                        <h3>{{ data.flaky_count }}</h3>
                        <p>Flaky Tests</p>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Time Range Filter -->
        <div class="section" style="background: #f9fafb; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: 600; color: #374151;">📅 Time Range:</label>
                <select id="timeRange" onchange="filterByTimeRange()" class="btn" style="min-width: 150px;">
                    <option value="all">All Time</option>
                    <option value="7">Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30">Last 30 days</option>
                </select>

                <label style="font-weight: 600; color: #374151; margin-left: 20px;">🔢 Show Runs:</label>
                <select id="runLimit" onchange="filterByRunLimit()" class="btn" style="min-width: 150px;">
                    <option value="10">Last 10 runs</option>
                    <option value="20" selected>Last 20 runs</option>
                    <option value="50">Last 50 runs</option>
                    <option value="all">All runs</option>
                </select>

                <button onclick="resetFilters()" class="btn btn-secondary" style="margin-left: auto;">🔄 Reset Filters</button>
            </div>
        </div>

        <!-- Pass Rate Trend Chart -->
        <div class="section">
            <h3>📈 Pass Rate History</h3>
            <div class="chart-container" style="height: 300px;">
                <canvas id="passRateHistoryChart"></canvas>
            </div>
        </div>

        <!-- Test Count Trend Chart -->
        <div class="section">
            <h3>📊 Test Execution Trend</h3>
            <div class="chart-container" style="height: 250px;">
                <canvas id="testCountChart"></canvas>
            </div>
        </div>

        <!-- Runs History Table -->
        <div class="section">
            <h3>📋 Run History</h3>
            <div class="table-container" id="runs-table">
                <table>
                    <thead>
                    <tr>
                        <th>Run ID</th>
                        <th>Timestamp</th>
                        <th>Suite</th>
                        <th>Tests</th>
                        <th>Pass Rate</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for run in data.runs %}
                        <tr>
                            <td><code>{{ run.run_id[:12] }}</code></td>
                            <td>{{ run.timestamp[:19].replace('T', ' ') }}</td>
                            <td>{{ run.suite_name }}</td>
                            <td>{{ run.passed }}/{{ run.total }}</td>
                            <td>
                            <span class="badge {% if run.pass_rate >= 80 %}badge-success{% elif run.pass_rate >= 50 %}badge-warning{% else %}badge-danger{% endif %}">
                                {{ run.pass_rate }}%
                            </span>
                            </td>
                            <td>{{ "%.2f"|format(run.duration) }}s</td>
                            <td>
                                {% if run.failed == 0 %}
                                    <span class="badge badge-success">✅ All Passed</span>
                                {% else %}
                                    <span class="badge badge-danger">❌ {{ run.failed }} Failed</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="/run/{{ run.run_id }}" class="btn btn-sm">View Run →</a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Individual Test Performance -->
        <div class="section">
            <h3>🧪 Individual Test Performance</h3>

            <!-- Filter Options -->
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="filterTests('all')" class="btn btn-sm" id="filter-all">All Tests</button>
                <button onclick="filterTests('flaky')" class="btn btn-sm" id="filter-flaky">⚠️ Flaky Only</button>
                <button onclick="filterTests('failing')" class="btn btn-sm" id="filter-failing">❌ Failing Only</button>
                <button onclick="filterTests('passing')" class="btn btn-sm" id="filter-passing">✅ Passing Only</button>
            </div>

            <div class="table-container" id="tests-table">
                <table>
                    <thead>
                    <tr>
                        <th>Test Name</th>
                        <th>Total Runs</th>
                        <th>Passed</th>
                        <th>Failed</th>
                        <th>Pass Rate</th>
                        <th>Avg Duration</th>
                        <th>Status</th>
                        <th>Last Failed</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for test in data.tests %}
                        <tr data-test-type="{% if test.is_flaky %}flaky{% elif test.failed == 0 %}passing{% else %}failing{% endif %}">
                            <td style="max-width: 300px; word-break: break-word;">{{ test.name }}</td>
                            <td>{{ test.total_runs }}</td>
                            <td><span class="badge badge-success">{{ test.passed }}</span></td>
                            <td><span class="badge badge-danger">{{ test.failed }}</span></td>
                            <td>
                            <span class="badge {% if test.pass_rate >= 80 %}badge-success{% elif test.pass_rate >= 50 %}badge-warning{% else %}badge-danger{% endif %}">
                                {{ test.pass_rate }}%
                            </span>
                            </td>
                            <td>{{ test.avg_duration }}s</td>
                            <td>
                                {% if test.is_flaky %}
                                    <span class="badge badge-warning">⚠️ Flaky</span>
                                {% elif test.last_status == 'PASS' %}
                                    <span class="badge badge-success">✅ Passing</span>
                                {% else %}
                                    <span class="badge badge-danger">❌ Failing</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if test.last_failed_run %}
                                    <a href="/run/{{ test.last_failed_run }}" class="btn btn-sm btn-secondary">View →</a>
                                {% else %}
                                    <span style="color: #10b981;">Never</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Comparison Tool (Optional) -->
        <div class="section" style="background: #f0f9ff; border-left: 4px solid #3b82f6;">
            <h3>🔍 Compare Runs</h3>
            <p style="color: #6b7280; margin-bottom: 15px;">Select two runs to compare their test results side-by-side</p>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <select id="compareRun1" class="btn" style="min-width: 200px;">
                    <option value="">Select first run...</option>
                    {% for run in data.runs[:10] %}
                        <option value="{{ run.run_id }}">{{ run.run_id[:12] }} - {{ run.timestamp[:19].replace('T', ' ') }}</option>
                    {% endfor %}
                </select>
                <span style="font-weight: 600; color: #374151;">vs</span>
                <select id="compareRun2" class="btn" style="min-width: 200px;">
                    <option value="">Select second run...</option>
                    {% for run in data.runs[:10] %}
                        <option value="{{ run.run_id }}">{{ run.run_id[:12] }} - {{ run.timestamp[:19].replace('T', ' ') }}</option>
                    {% endfor %}
                </select>
                <button onclick="compareRuns()" class="btn btn-primary">🔀 Compare</button>
            </div>
            <div id="comparison-result" style="margin-top: 20px;"></div>
        </div>

    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        const tagName = "{{ tag }}";
        const allTests = {{ data.tests | tojson }};
        let charts = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadCharts();
            initializeFilters();
        });

        async function loadCharts() {
            try {
                const response = await fetch(`/api/tag/${tagName}/history?limit=20`);
                const data = await response.json();

                createPassRateChart(data);
                createTestCountChart(data);
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        function createPassRateChart(data) {
            const ctx = document.getElementById('passRateHistoryChart');
            if (charts.passRate) charts.passRate.destroy();

            charts.passRate = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.timestamps.map(t => formatTimestamp(t)),
                    datasets: [{
                        label: 'Pass Rate %',
                        data: data.pass_rates,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Pass Rate: ' + context.parsed.y + '%';
                                },
                                afterLabel: function(context) {
                                    const runId = data.run_ids[context.dataIndex];
                                    return 'Click to view run: ' + runId.substring(0, 12);
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const runId = data.run_ids[index];
                            window.location.href = `/run/${runId}`;
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }

        function createTestCountChart(data) {
            const ctx = document.getElementById('testCountChart');
            if (charts.testCount) charts.testCount.destroy();

            charts.testCount = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.timestamps.map(t => formatTimestamp(t)),
                    datasets: [{
                        label: 'Number of Tests',
                        data: data.test_counts,
                        backgroundColor: '#3b82f6',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function initializeFilters() {
            document.getElementById('filter-all').classList.add('btn-primary');
        }

        function filterTests(type) {
            // Update button states
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-sm');
            });
            document.getElementById(`filter-${type}`).classList.add('btn-primary');

            // Filter table rows
            const rows = document.querySelectorAll('#tests-table tbody tr');
            rows.forEach(row => {
                const testType = row.getAttribute('data-test-type');
                if (type === 'all' || testType === type) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterByTimeRange() {
            const days = document.getElementById('timeRange').value;
            if (days === 'all') {
                location.reload();
                return;
            }

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(days));

            const rows = document.querySelectorAll('#runs-table tbody tr');
            rows.forEach(row => {
                const timestamp = row.cells[1].textContent;
                const rowDate = new Date(timestamp);
                row.style.display = rowDate >= cutoffDate ? '' : 'none';
            });
        }

        function filterByRunLimit() {
            const limit = document.getElementById('runLimit').value;
            const rows = document.querySelectorAll('#runs-table tbody tr');

            if (limit === 'all') {
                rows.forEach(row => row.style.display = '');
                return;
            }

            rows.forEach((row, index) => {
                row.style.display = index < parseInt(limit) ? '' : 'none';
            });
        }

        function resetFilters() {
            document.getElementById('timeRange').value = 'all';
            document.getElementById('runLimit').value = '20';
            filterByTimeRange();
            filterByRunLimit();
        }

        function exportTagData() {
            window.location.href = `/api/tag/${tagName}/export`;
        }

        async function compareRuns() {
            const run1 = document.getElementById('compareRun1').value;
            const run2 = document.getElementById('compareRun2').value;

            if (!run1 || !run2) {
                alert('Please select two runs to compare');
                return;
            }

            if (run1 === run2) {
                alert('Please select different runs');
                return;
            }

            const resultDiv = document.getElementById('comparison-result');
            resultDiv.innerHTML = '<p class="loading">Loading comparison...</p>';

            try {
                const [data1, data2] = await Promise.all([
                    fetch(`/api/runs/${run1}`).then(r => r.json()),
                    fetch(`/api/runs/${run2}`).then(r => r.json())
                ]);

                // Filter tests by tag
                const tests1 = data1.tests.filter(t => t.tags.includes(tagName));
                const tests2 = data2.tests.filter(t => t.tags.includes(tagName));

                const passed1 = tests1.filter(t => t.status === 'PASS').length;
                const passed2 = tests2.filter(t => t.status === 'PASS').length;
                const total1 = tests1.length;
                const total2 = tests2.length;

                const passRate1 = (passed1 / total1 * 100).toFixed(2);
                const passRate2 = (passed2 / total2 * 100).toFixed(2);
                const diff = (passRate2 - passRate1).toFixed(2);

                let html = `
                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin-bottom: 15px;">Comparison Results</h4>
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center;">
                        <div style="text-align: center; padding: 15px; background: #f9fafb; border-radius: 8px;">
                            <div style="font-size: 0.9em; color: #6b7280; margin-bottom: 5px;">Run 1</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #1f2937;">${passRate1}%</div>
                            <div style="margin-top: 5px; color: #6b7280;">${passed1}/${total1} passed</div>
                        </div>
                        <div style="font-size: 2em;">
                            ${diff > 0 ? '📈' : diff < 0 ? '📉' : '➡️'}
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f9fafb; border-radius: 8px;">
                            <div style="font-size: 0.9em; color: #6b7280; margin-bottom: 5px;">Run 2</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #1f2937;">${passRate2}%</div>
                            <div style="margin-top: 5px; color: #6b7280;">${passed2}/${total2} passed</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: ${diff > 0 ? '#dcfce7' : diff < 0 ? '#fee2e2' : '#f3f4f6'}; border-radius: 8px;">
                        <strong>Difference:</strong>
                        <span style="font-size: 1.2em; font-weight: bold; color: ${diff > 0 ? '#10b981' : diff < 0 ? '#ef4444' : '#6b7280'};">
                            ${diff > 0 ? '+' : ''}${diff}%
                        </span>
                    </div>
                </div>
            `;

                resultDiv.innerHTML = resultDiv.innerHTML = html;

            } catch (error) {
                console.error('Error comparing runs:', error);
                resultDiv.innerHTML = '<p style="color: #ef4444;">❌ Error loading comparison data</p>';
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            return timestamp.substring(0, 19).replace('T', ' ');
        }
    </script>

    <style>
        @media print {
            .header-actions,
            .breadcrumb,
            button {
                display: none !important;
            }

            .section {
                page-break-inside: avoid;
            }
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-sm:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .btn-sm.btn-primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .btn-sm.btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .stat-card.success {
            border-left: 4px solid #10b981;
        }

        .stat-card.warning {
            border-left: 4px solid #f59e0b;
        }

        .stat-card.danger {
            border-left: 4px solid #ef4444;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-style: italic;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.875em;
        }

        .tag {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
{% endblock %}